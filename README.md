# íŠ¸ìœ„í„° ì‹œìŠ¤í…œ ë””ìì¸ ì‹¤í—˜

ì‹¤í—˜ê¸° ê¸€ ë§í¬ - [https://hyeon9mak.github.io/twitter-system-design-experiment](https://hyeon9mak.github.io/twitter-system-design-experiment)

## ì†Œê°œ

> [ì½”ë§¹íƒˆì¶œ ì±„ë„ì˜ íŠ¸ìœ„í„° ì‹œìŠ¤í…œ ë””ìì¸ ì™„ì „ì •ë³µ | 1ì–µ ìœ ì € ì²˜ë¦¬ì˜ ë¹„ë°€](https://www.youtube.com/watch?v=6QwqtdBx0oE) ì˜ìƒì„ ë³´ê³  ê°„ì†Œí•˜ê²Œ í…ŒìŠ¤íŠ¸ í•´ë³¸ ë‚´ìš©ì…ë‹ˆë‹¤.

ì˜ìƒ ë‚´ìš©ì— ë”°ë¥¸ 3ê°€ì§€ ì‹œìŠ¤í…œ ë””ìì¸ì„ ë¸Œëœì¹˜ ë³„ë¡œ ë‚˜ëˆ„ì–´ ë‘ì—ˆìŠµë‹ˆë‹¤.

- [`simple-tweet`: íŠ¸ìœ— í¬ìŠ¤íŠ¸ë¥¼ ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ê³ , í”¼ë“œ ìš”ì²­ì‹œ ë³µì¡ì„± ì²˜ë¦¬](https://github.com/Hyeon9mak/twitter-system-design/tree/simple-tweet)
- [`simple-feed`: í”¼ë“œ ìš”ì²­ì„ ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ê³ , íŠ¸ìœ— í¬ìŠ¤íŠ¸ì‹œ ë³µì¡ì„± ì²˜ë¦¬](https://github.com/Hyeon9mak/twitter-system-design/tree/simple-feed)
- [`simple-feed-and-influencer`: í”¼ë“œ ìš”ì²­ì„ ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ê³ , íŠ¸ìœ— í¬ìŠ¤íŠ¸ì‹œ ë³µì¡ì„± ì²˜ë¦¬, ì¸í”Œë£¨ì–¸ì„œ ì²˜ë¦¬](https://github.com/Hyeon9mak/twitter-system-design/tree/simple-feed-and-influencer)

<br>

## ì‹œìŠ¤í…œ ë””ìì¸ - í”¼ë“œ ìš”ì²­ì„ ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ê³ , íŠ¸ìœ— í¬ìŠ¤íŠ¸ì‹œ ë³µì¡ì„± ì²˜ë¦¬

### íŠ¸ìœ— í¬ìŠ¤íŠ¸
![image](docs/tweet.png)

### í”¼ë“œ ìš”ì²­
![image](docs/feed.png)

<br>

## í”„ë¡œì íŠ¸ ì„¤ì • ë° í…ŒìŠ¤íŠ¸ í™˜ê²½

### í…ŒìŠ¤íŠ¸ í™˜ê²½

- SpringBoot 2.7.8
- Kotlin 1.7
- JAVA 17
- mariadb 10.5.18
- redis 6.2.6
- CPU Apple M1 Pro / Memory 32GB / OS Ventura 13.1
- K6 v0.42.0

### ì¸í”„ë¼

![image](docs/infra.png)

### íŒ”ë¡œì›Œ ê´€ê³„

![image](docs/dataset.png)

<br>

## í…ŒìŠ¤íŠ¸ ê²°ê³¼

### í”¼ë“œ ì¡°íšŒ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

User A ì™€ User B ê°€ í”¼ë“œ ì¡°íšŒë¥¼ ìš”ì²­í•œë‹¤.

> - VUser 1, 60 sec
> - GET /api/v1/feeds?user-id=10002 (User A)
> - GET /api/v1/feeds?user-id=10003 (User B)

![image](docs/look_up_1.png)
![image](docs/look_up_2.png)
![image](docs/look_up_3.png)

http_req_duration í‰ê·  152.53ms (`(158.17 + 145.48 + 153.93) / 3`) 

simple-tweet ì˜ í‰ê·  58.43ms ë³´ë‹¤ í•œì°¸ ëŠë¦° ê²°ê³¼.  
redis lrange ëª…ë ¹ì–´ê°€ ê°€ì§€ëŠ” O(S+N) ì‹œê°„ë³µì¡ë„ ë•Œë¬¸ì¼ ê²ƒìœ¼ë¡œ ì˜ˆìƒí•˜ê³ 
ZSET ì„ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ ì¬ì‹œë„

![image](docs/look_up_4.png)

O(lg(N)+M) ì‹œê°„ ë³µì¡ë„ë¥¼ ê°€ì§„ ZSET ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•´ë³´ì•˜ìœ¼ë‚˜ ì„±ëŠ¥ì´ í¬ê²Œ ê°œì„ ë˜ì§€ ì•ŠìŒ

![image](docs/hikari_pool.png)

ì™¸ë¶€ì™€ ì—°ê²°ì„ ì£¼ê³  ë°›ì§€ ì•ŠëŠ” ë¡œì»¬ í™˜ê²½ì˜ í•œê³„ì™€
~~HikariCP ì˜ ê¸°ë³¸ ì»¤ë„¥ì…˜ í’€ì´ 10ê°œì™€ redis ì˜ ì‹±ê¸€ ìŠ¤ë ˆë“œ ë¬¸ì œì¼ ê²ƒìœ¼ë¡œ ì¶”ì¸¡ì¤‘...~~
2023-02-12 HikariCP ì»¤ë„¥ì…˜ í’€ ìµœëŒ€ ê°œìˆ˜ë¥¼ 3ê°œë¡œ ì¤„ì—¬ì„œ ì¬ì‹¤í—˜ í•´ë³´ì•˜ìœ¼ë‚˜ í° ì°¨ì´ê°€ ì—†ì—ˆìŒ.
ì»¤ë„¥ì…˜ í’€ë¡œ ì¸í•œ ì´ìƒ í˜„ìƒì€ ì•„ë‹Œ ê²ƒ ê°™ìŒ.

### íŠ¸ìœ— ì§í›„ ì¡°íšŒì‹œ ì •í•©ì„± í…ŒìŠ¤íŠ¸

ì˜¤ë°”ë§ˆë¥¼ íŒ”ë¡œì›Œì¤‘ì¸ User 1 ê³¼ User 10,000 ì´ í”¼ë“œë¥¼ ì¡°íšŒí•˜ë˜ ì¤‘
ì˜¤ë°”ë§ˆê°€ íŠ¸ìœ—ì„ í–ˆì„ ë•Œ User 1 ê³¼ User 10,000 ê°€ ë™ì¼í•œ í”¼ë“œë¥¼ ë³´ê³  ìˆì„ í™•ë¥  í…ŒìŠ¤íŠ¸

> - VUser 1, 60 sec
> - GET /api/v1/feeds?user-id=1 (User 1)
> - GET /api/v1/feeds?user-id=10000 (User 10,000)
> - POST /api/v1/tweets (Obama tweet after 10 sec)

![image](docs/fan_out_1.png)
![image](docs/fan_out_2.png)
![image](docs/fan_out_3.png)

same response 71.67% (`(72 + 71 + 72) / 3`)  
28.33% ì˜ ì‹œê°„ë™ì•ˆ í•œëª…ì€ ì˜¤ë°”ë§ˆì˜ íŠ¸ìœ—ì„ í™•ì¸í•˜ì§€ ëª»í•˜ê³  ìˆìŒ

<br>

> ## 2023-03-03 ë‚´ìš© ì¶”ê°€
>
> JerryK026 ë‹˜ê»˜ì„œ ëŒ“ê¸€ì— "mariadb ê°€ ìë™ìœ¼ë¡œ hash ê²€ìƒ‰ì„ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì— ë¹ ë¥´ê²Œ ì²˜ë¦¬ëœê²ƒ ì•„ë‹ˆëƒ" ë¼ëŠ” ì•„ì´ë””ì–´ë¥¼ ì œê³µí•´ì£¼ì…¨ë‹¤.
> ì´ ë•Œë¬¸ì— ë¹„êµë¥¼ ìœ„í•´ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆëŠ”ë°, ê¸°ëŒ€ì— ë¶€ì‘í•˜ëŠ” ìˆ˜ì¹˜ê°€ ë‚˜ì™”ë‹¤.
>
> ![image](https://user-images.githubusercontent.com/37354145/224552003-3c2ff180-77a5-4cfc-bed1-f6616ec90e72.png)
>
> simple-tweet: 38.2ms
>
> ![image](https://user-images.githubusercontent.com/37354145/224552015-cdd720e5-013b-4963-a778-fe7215bd79f7.png)
>
> simple-feed: 36.97ms
>
> ![image](https://user-images.githubusercontent.com/37354145/224552025-41fdcb98-0ad3-4254-b6e2-08cfefaf0474.png)
>
> simple-feed-and-influencer: 48.76ms
> (simple-feed-and-finluencer ê°™ì€ ê²½ìš° ì¼ë°˜ í”¼ë“œì™€ ì¸í”Œë£¨ì–¸ì„œ í”¼ë“œë¥¼ ì¡°ë¦½í•˜ëŠ” ê³¼ì •ì´ ì¶”ê°€ë˜ê¸° ë•Œë¬¸ì— ì €ì •ë„ ì†ë„ê°€ ë‚˜ì˜¤ëŠ” ê²ƒìœ¼ë¡œ ìƒê°)
>
> ì•„ë¬´ë˜ë„ ì´ì „ í™˜ê²½ ì„¸íŒ…ì— ë¬¸ì œê°€ ìˆì—ˆë˜ ê²ƒ ê°™ë‹¤. ğŸ¤”
> ë³„ê°œë¡œ ì œê³µí•´ì£¼ì‹  ì•„ì´ë””ì–´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì—¬ëŸ¬ê°€ì§€ ê°€ì„¤ì„ ì„¸ìš°ê³  í™•ì¸í•´ë³´ì•˜ë‹¤.
>
> ## ê°€ì„¤ 1. mariadb ê°€ index íƒìƒ‰ì‹œ hash tableì„ ì´ìš©í–ˆë‹¤.
> ìš°ì„  [mariadb storage engine index types](https://mariadb.com/kb/en/storage-engine-index-types/) ê´€ë ¨ ë¬¸ì„œë¥¼ í™•ì¸í•´ë³´ì•˜ë‹¤.
> ë¬¸ì„œì—ì„œëŠ” mariadb ê°€ index types ìœ¼ë¡œ btree ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì™€ hash ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ë¥¼ ë‚˜ì—´í•´ì£¼ì—ˆëŠ”ë°, ê¸°ë³¸ì ìœ¼ë¡œëŠ” btree ë¥¼ ì‚¬ìš©í•˜ê³  MEMORY íƒ€ì…ì¸ ê²½ìš° hash ë¥¼ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.
>
> >  BTREE is generally the default index type. For MEMORY tables, HASH is the default.
>
> flyway ë¥¼ í†µí•´ í…Œì´ë¸”ì„ ìƒì„±í•  ë•Œ ë³„ê°œ storage engine ì„ ëª…ì‹œí•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— MEMORY íƒ€ì…ìœ¼ë¡œ í…Œì´ë¸”ì´ ìƒì„±ë˜ì—ˆì„ ê°€ëŠ¥ì„±ì„ ì—¼ë‘ì— ë‘ì–´ mysql ë‚´ë¶€ ì„¤ì •ì„ í™•ì¸í•´ë³´ì•˜ëŠ”ë°, ê²°ê³¼ëŠ” InnoDB íƒ€ì…ì´ì—ˆë‹¤.
>
> ```sql
> MariaDB [tweeter_system_design]> SELECT engine FROM information_schema.TABLES where table_name='tweet';
> +--------+
> | engine |
> +--------+
> | InnoDB |
> +--------+
> ```
>
> ë˜í•œ ê° í…Œì´ë¸”ë“¤ì´ ì–´ë–¤ êµ¬ì¡°ì˜ ì¸ë±ìŠ¤ë¥¼ ê°–ê³  ìˆëŠ”ì§€ í™•ì¸í–ˆë‹¤. ê²°ê³¼ëŠ” ëª¨ë‘ btree ì˜€ë‹¤.
>
> ```sql
> MariaDB [tweeter_system_design]> show indexes from tweet;
> +-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
> | Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
> +-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
> | tweet |          0 | PRIMARY  |            1 | id          | A         |        9926 |     NULL | NULL   |      | BTREE      |         |               |
> +-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
>
> MariaDB [tweeter_system_design]> show indexes from follow;
> +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
> | Table  | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
> +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
> | follow |          0 | PRIMARY  |            1 | followee_id | A         |       20137 |     NULL | NULL   |      | BTREE      |         |               |
> | follow |          0 | PRIMARY  |            2 | follower_id | A         |       20137 |     NULL | NULL   |      | BTREE      |         |               |
> +--------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
>
> MariaDB [tweeter_system_design]> show indexes from user;
> +-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
> | Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
> +-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
> | user  |          0 | PRIMARY  |            1 | id          | A         |       10090 |     NULL | NULL   |      | BTREE      |         |               |
> +-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
> ```
>
> ì•„ì‰½ê²Œë„ ê°€ì„¤ 1 ì€ ì›ì¸ì´ ì•„ë‹ˆì—ˆìŒì„ ì•Œê²Œ ë˜ì—ˆë‹¤.
>
>
> ## ê°€ì„¤ 2. Adaptive Hash Index í™œìš©
>
> ì¡°ì‚¬ ê³¼ì •ì—ì„œ [InnoDBì˜ Adaptive Hash Index í™œìš©](https://tech.kakao.com/2016/04/07/innodb-adaptive-hash-index/)ì— ëŒ€í•´ ì•Œê²Œ ë˜ì—ˆë‹¤. 
> ì˜µí‹°ë§ˆì´ì €ê°€ ë‚´ë¶€ì ìœ¼ë¡œ íŒë‹¨í•´ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ë¥¼ Adaptive Hash Index ë¥¼ í†µí•´ ì ‘ê·¼/ì²˜ë¦¬ë¥¼ í•œë‹¤ê³  í•œë‹¤.
>
> > ... ìì£¼ ì‚¬ìš©ë˜ëŠ” ë°ì´í„° íƒìƒ‰ì—ë„ ë§¤ë²ˆ íŠ¸ë¦¬ì˜ ê²½ë¡œë¥¼ ì«“ì•„ê°€ì•¼ í•œë‹¤ëŠ” ê²ƒì´ì£ . ê²Œë‹¤ê°€ Mutex Lockì´ ê³¼ë„í•˜ê²Œ ì¡íˆê²Œ ë˜ë©´, ì ì€ ë°ì´í„° ì…‹ì—ë„ ë¶ˆêµ¬í•˜ê³  DB ìì› ì‚¬ìš© íš¨ìœ¨ì´ ë–¨ì–´ì§€ê²Œ ë©ë‹ˆë‹¤.
>
> > InnoDBì—ì„œëŠ” ì•ì„œ ì–¸ê¸‰í•œ ìƒí™©ì„ í•´ê²°í•˜ê¸° ìœ„í•´, InnoDB Adative Hash Index ê¸°ëŠ¥ì´ ìˆìŠµë‹ˆë‹¤. ìì£¼ ì‚¬ìš©ë˜ëŠ” ì¹¼ëŸ¼ì„ í•´ì‹œë¡œ ì •ì˜í•˜ì—¬, B-Tree ë¥¼ íƒ€ì§€ ì•Šê³  ë°”ë¡œ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ì£ . â€œAdaptiveâ€ë¼ëŠ” ë‹¨ì–´ì—ì„œ ì˜ˆìƒí•  ìˆ˜ ìˆê² ì§€ë§Œ, ëª¨ë“  ê°’ë“¤ì´ í•´ì‹œë¡œ ìƒì„±ì´ ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ìì£¼ ì‚¬ìš©ë˜ëŠ” ë°ì´í„° ê°’ë§Œ ë‚´ë¶€ì ìœ¼ë¡œ íŒë‹¨í•˜ì—¬ ìƒí™©ì— ë§ê²Œ í•´ì‹œ ê°’ì„ ìƒì„±í•©ë‹ˆë‹¤.
>
> ì‹¤í—˜ì— ì‚¬ìš©ëœ mariadb ê°€ ë‚´ë¶€ì ìœ¼ë¡œ Adaptive Hash index ë¥¼ í™œìš©ì¤‘ì¸ì§€ í™•ì¸í–ˆìœ¼ë‚˜, ê²°ë¡ ì€ ì•„ì‰½ê²Œë„ ì•„ë‹ˆì—ˆë‹¤.
>
> ```sql
> MariaDB [tweeter_system_design]> show variables like '%adaptive%';
> +----------------------------------+-----------+
> | Variable_name                    | Value     |
> +----------------------------------+-----------+
> | innodb_adaptive_hash_index       | OFF       |
> | innodb_adaptive_hash_index_parts | 8         |
> | innodb_adaptive_max_sleep_delay  | 0         |
> +----------------------------------+-----------+
>
> MariaDB [tweeter_system_design]> show global status like 'Innodb_adaptive_hash%';
> +----------------------------------------+--------+
> | Variable_name                          | Value  |
> +----------------------------------------+--------+
> | Innodb_adaptive_hash_hash_searches     | 0      |
> | Innodb_adaptive_hash_non_hash_searches | 140975 |
> +----------------------------------------+--------+
> ```
>
> ì•„ì‰½ê²Œë„ ê°€ì„¤ 2 ë˜í•œ ì›ì¸ì´ ì•„ë‹ˆì—ˆìŒì„ ì•Œê²Œ ë˜ì—ˆë‹¤.
>
> ê²°ë¡ ì ìœ¼ë¡œ ê¸°ì¡´ í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ ì˜ëª» ì„¤ì •ë˜ì–´ ì •ìƒì ì´ì§€ ì•Šì€ ìˆ˜ì¹˜ê°€ ë‚˜ì™”ë˜ ê²ƒ ê°™ë‹¤.
